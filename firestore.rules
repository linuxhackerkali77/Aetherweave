
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for ownership
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Users can create their own user document, which contains profile, stats, etc.
    // Any authenticated user can read another user's profile and list users (for search).
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, list: if request.auth != null;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    match /users/{userId}/inventory/{inventoryItemId} {
        allow read, write: if isOwner(userId);
    }
    
    match /users/{userId}/signaling/{peerId}/{document=**} {
        allow read, write, delete: if isOwner(userId) || isOwner(peerId);
    }

    match /chats/{chatId} {
      allow read, update: if request.auth.uid in resource.data.participants;
      allow create: if request.auth.uid in request.resource.data.participants;
    }
    
    match /chats/{chatId}/messages/{messageId} {
      // Allow read if the user is a participant in the message.
      allow read: if request.auth.uid in resource.data.participants;
      
      // Allow create if the user is the sender and is a participant.
      allow create: if isOwner(request.resource.data.senderId) && request.auth.uid in request.resource.data.participants;
      
      // Allow update only for reactions and status changes by participants.
      // Disallow changing any other field.
      allow update: if request.auth.uid in resource.data.participants
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'status']);
                    
      allow delete: if false;
    }
    
    match /notes/{noteId} {
      // A user can create a note if the note's userId matches their own.
      // They can read, update, and delete notes they own.
      allow create: if isOwner(request.resource.data.userId);
      allow read, update, delete: if isOwner(resource.data.userId);
    }
    
    match /users/{userId}/notifications/{notificationId} {
        allow read, write: if isOwner(userId);
    }

    match /users/{userId}/connections/{otherUserId} {
        allow list, read, delete: if isOwner(userId);
        
        allow create: if request.resource.data.status == 'pending' && isOwner(request.resource.data.requestedBy);

        allow update: if (isOwner(userId)) || 
                       (get(/databases/$(database)/documents/users/$(userId)/connections/$(otherUserId)).data.status == 'pending' && 
                        request.resource.data.status == 'friends');
    }

    // Story subcollection rules for collection group queries
    match /{path=**}/stories/{storyId} {
      // Allow authenticated users to list stories (for the story reel)
      allow list: if request.auth != null;
      // Allow users to get, write and delete their own stories.
      allow get, write, delete: if isOwner(resource.data.userId);
    }

    // Master data collections (badges, quests) should be read-only for clients
    match /badges/{badgeId} {
        allow get, list: if request.auth != null;
    }
     match /quests/{questId} {
        allow get, list: if request.auth != null;
    }
    
    // Activity Feed rules
    match /activity/{activityId} {
        // Logged-in users can read the feed, but cannot write directly.
        allow read: if request.auth != null;
        allow write: if false; 
    }

    // App Stats rules
    match /app-stats/{appId} {
        allow read, list: if request.auth != null;
        allow write: if request.auth != null && (
            // Allow creating the document
            !exists(/databases/$(database)/documents/app-stats/$(appId)) ||
            // Allow incrementing the viewCount
            request.resource.data.viewCount == resource.data.viewCount + 1
        );
    }
    
    // ========================================
    // ðŸŽ® GAMING DASHBOARD RULES
    // ========================================

    // Gaming usernames must be unique, checked at application level.
    // User can update their own gaming profile.
    match /users/{userId} {
        allow update: if isOwner(userId) && onlyUpdatingGamingFields();
    }

    function onlyUpdatingGamingFields() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['gaming']);
    }

    // Gaming friends are separate from main connections
    match /users/{userId}/gamingFriends/{friendId} {
       allow list, read, delete: if isOwner(userId);
       allow create, update: if isOwner(userId) || isOwner(friendId);
    }
    
    // Gaming servers can be read by anyone, but only written to by members (future rule)
    match /gamingServers/{serverId} {
        allow read: if request.auth != null;
        // Simplified write rule for now
        allow write: if request.auth != null;
    }
    
    // Gaming DMs can only be accessed by participants
    match /gamingDMs/{dmId} {
       allow read, update: if request.auth.uid in resource.data.participants;
       allow create: if request.auth.uid in request.resource.data.participants;
    }

    match /gamingDMs/{dmId}/messages/{messageId} {
        allow read, create: if request.auth.uid in get(/databases/$(database)/documents/gamingDMs/$(dmId)).data.participants;
    }
  }
}
